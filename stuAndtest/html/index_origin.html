<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI图像生成参数配置</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
        color: #333;
        min-height: 100vh;
        padding: 20px;
        display: flex;
        flex-direction: column;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow: hidden;
        flex: 1;
        display: flex;
        flex-direction: column;
      }

      header {
        background: linear-gradient(to right, #4b6cb7, #182848);
        color: white;
        padding: 15px 25px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
        gap: 15px;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .logo i {
        font-size: 28px;
        color: #ffd166;
      }

      .logo h1 {
        font-size: 22px;
        font-weight: 700;
      }

      .preset-selector {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }

      .preset-label {
        font-weight: 600;
        font-size: 16px;
      }

      .preset-btn {
        padding: 8px 15px;
        background: #f0f4ff;
        border: 1px solid #4b6cb7;
        border-radius: 20px;
        color: #4b6cb7;
        font-size: 14px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .preset-btn:hover {
        background: #4b6cb7;
        color: white;
      }

      .preset-btn.active {
        background: #4b6cb7;
        color: white;
      }

      .main-content {
        display: flex;
        flex: 1;
        overflow: hidden;
      }

      .params-panel {
        flex: 1;
        padding: 20px;
        border-right: 1px solid #eee;
        overflow-y: auto;
        min-width: 350px;
      }

      .results-panel {
        flex: 1;
        padding: 20px;
        background: #f9f9f9;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
        min-width: 350px;
      }

      .panel-title {
        font-size: 20px;
        font-weight: 600;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #4b6cb7;
        color: #182848;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .panel-title i {
        color: #4b6cb7;
      }

      .form-group {
        margin-bottom: 18px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 600;
        color: #444;
      }

      input,
      textarea,
      select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: all 0.3s;
      }

      input:focus,
      textarea:focus,
      select:focus {
        outline: none;
        border-color: #4b6cb7;
        box-shadow: 0 0 0 3px rgba(75, 108, 183, 0.2);
      }

      textarea {
        min-height: 100px;
        resize: vertical;
      }

      .slider-container {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .slider-container input[type="range"] {
        flex: 1;
      }

      .slider-value {
        min-width: 50px;
        text-align: center;
        font-weight: 600;
        color: #4b6cb7;
      }

      .param-section {
        background: white;
        border-radius: 10px;
        padding: 18px;
        margin-bottom: 22px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .section-title {
        font-size: 18px;
        margin-bottom: 15px;
        color: #182848;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section-title i {
        color: #4b6cb7;
      }

      .upload-area {
        border: 2px dashed #4b6cb7;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s;
        background: #f8fbff;
      }

      .upload-area:hover {
        background: #eef5ff;
      }

      .upload-area i {
        font-size: 48px;
        color: #4b6cb7;
        margin-bottom: 15px;
      }

      .image-preview {
        max-width: 100%;
        max-height: 200px;
        margin-top: 15px;
        border-radius: 8px;
        display: block;
        margin-left: auto;
        margin-right: auto;
      }

      .btn-group {
        display: flex;
        gap: 15px;
        margin-top: 25px;
      }

      .btn {
        padding: 14px 25px;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
      }

      .btn-primary {
        background: linear-gradient(to right, #4b6cb7, #182848);
        color: white;
        flex: 1;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(75, 108, 183, 0.4);
      }

      .btn-primary:disabled {
        background: #a0aec0;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .btn-secondary {
        background: #f0f0f0;
        color: #444;
      }

      .btn-secondary:hover {
        background: #e0e0e0;
      }

      .btn-secondary:disabled {
        background: #d1d5db;
        cursor: not-allowed;
      }

      .results-container {
        gap: 20px;
        padding: 15px;
        overflow-y: auto;
        max-height: 85vh;
      }

      .progress-container {
        background: white;
        border-radius: 10px;
        padding: 20px;
        margin-top: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
      }

      .single-result {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 20px;
        max-height: calc(100vh - 200px);
        overflow-y: auto;
      }

      .single-image {
        max-width: 100%;
        max-height: 60vh;
        border-radius: 10px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        object-fit: contain;
        background: #f5f5f5;
        border: 1px solid #eee;
      }

      .result-details {
        margin-top: 20px;
        width: 100%;
        background: white;
        border-radius: 10px;
        padding: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        max-width: 800px;
      }

      .result-item {
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        width: calc(50% - 10px);
        margin-bottom: 10px;
      }

      .result-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        display: block;
      }

      .result-info {
        padding: 15px;
      }

      .result-model {
        font-weight: 600;
        color: #182848;
        margin-bottom: 5px;
      }

      .result-prompt {
        font-size: 14px;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
      }

      .progress-bar {
        height: 20px;
        background: #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(to right, #4b6cb7, #182848);
        border-radius: 10px;
        transition: width 0.5s;
      }

      .progress-text {
        text-align: center;
        font-weight: 600;
        color: #444;
      }
      /* 下载按钮样式 */
      .download-container {
        margin-top: 15px;
        text-align: center;
      }

      .download-btn {
        display: inline-block;
        padding: 8px 20px;
        background: linear-gradient(to right, #4b6cb7, #182848);
        color: white;
        border-radius: 5px;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.3s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
      }

      /* 单个结果中的下载按钮 */
      .single-result .download-btn {
        padding: 10px 25px;
        font-size: 16px;
      }
      .history-panel {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-top: 20px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
        max-height: 250px;
        overflow-y: auto;
      }

      .history-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .history-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        flex-direction: column;
      }

      .history-item:hover {
        background: #f5f8ff;
      }

      .history-title {
        font-weight: 600;
        color: #182848;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
      }

      .history-date {
        font-size: 12px;
        color: #777;
      }

      .history-prompt {
        font-size: 14px;
        color: #666;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }

      .detail-row {
        display: flex;
        margin-bottom: 10px;
      }

      .detail-label {
        font-weight: 600;
        color: #182848;
        width: 120px;
      }

      .detail-value {
        flex: 1;
        color: #444;
        word-break: break-word;
      }

      .no-results {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 14%;
        color: #888;
        text-align: center;
        padding: 30px;
      }

      .no-results i {
        font-size: 64px;
        margin-bottom: 20px;
        color: #ccc;
      }

      .error-message {
        background: #ffecec;
        color: #e74c3c;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        border-left: 4px solid #e74c3c;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .clear-history-btn {
        background: none;
        border: none;
        color: #e74c3c;
        cursor: pointer;
        font-size: 14px;
        padding: 5px;
      }

      .clear-history-btn:hover {
        text-decoration: underline;
      }

      .status-indicator {
        display: inline-block;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
      }

      .status-idle {
        background-color: #ccc;
      }

      .status-processing {
        background-color: #4b6cb7;
        animation: pulse 1.5s infinite;
      }

      @keyframes pulse {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.4;
        }
        100% {
          opacity: 1;
        }
      }

      @media (max-width: 992px) {
        .main-content {
          flex-direction: column;
        }

        .params-panel {
          border-right: none;
          border-bottom: 1px solid #eee;
        }

        header {
          flex-direction: column;
          align-items: flex-start;
        }

        .preset-selector {
          margin-top: 10px;
        }
      }
      /* 下载按钮加载动画 */
      .fa-spinner {
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* 禁用状态 */
      .download-btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
      }

      @media (max-width: 768px) {
        .btn-group {
          flex-direction: column;
        }

        .single-image {
          max-height: 50vh;
        }

        .history-panel {
          max-height: 200px;
        }
      }

      /* 图片详情模态框样式 */
      .image-detail-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
      }

      .modal-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        position: relative;
        background: #1e1e2e;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        width: 90%;
        max-width: 1000px;
        max-height: 90vh;
        display: flex;
        overflow: hidden;
        z-index: 1001;
      }

      .close-btn {
        position: absolute;
        top: 15px;
        right: 15px;
        background: rgba(255, 255, 255, 0.1);
        border: none;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        color: white;
        font-size: 18px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        z-index: 10;
      }

      .close-btn:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      .image-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: #121220;
      }

      .detail-image {
        max-width: 100%;
        max-height: 80vh;
        border-radius: 8px;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      .image-info {
        flex: 1;
        padding: 30px;
        background: #2a2a3a;
        overflow-y: auto;
        max-height: 80vh;
      }

      .image-info h3 {
        color: #8a5cf6;
        margin-bottom: 20px;
        font-size: 1.5rem;
        border-bottom: 1px solid #444;
        padding-bottom: 10px;
      }

      .info-row {
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 1px solid #333;
      }

      .info-label {
        display: block;
        color: #8a5cf6;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .info-value {
        color: #e2e2e2;
        line-height: 1.5;
      }

      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 20px;
      }

      .btn {
        padding: 10px 20px;
        border-radius: 6px;
        border: none;
        font-weight: 600;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s ease;
      }

      .download-btn {
        background: linear-gradient(135deg, #8a5cf6, #6d28d9);
        color: white;
      }

      .download-btn:hover {
        background: linear-gradient(135deg, #9b76f7, #7d3ce0);
        transform: translateY(-2px);
      }

      .close-btn {
        background: #444;
        color: #ccc;
      }

      .close-btn:hover {
        background: #555;
      }

      /* 结果区域按钮样式 */
      .action-buttons {
        display: flex;
        gap: 10px;
        margin-top: 15px;
      }

      .action-btn {
        padding: 8px 15px;
        border-radius: 6px;
        font-size: 0.9rem;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
      }

      .view-btn {
        background: rgba(138, 92, 246, 0.2);
        color: #8a5cf6;
        border: 1px solid #8a5cf6;
      }

      .view-btn:hover {
        background: rgba(138, 92, 246, 0.3);
      }

      .download-btn {
        background: rgba(74, 222, 128, 0.2);
        color: #4ade80;
        border: 1px solid #4ade80;
      }

      .download-btn:hover {
        background: rgba(74, 222, 128, 0.3);
      }

      .result-image,
      .single-image {
        cursor: pointer;
        transition: transform 0.3s ease;
      }

      .result-image:hover,
      .single-image:hover {
        transform: scale(1.02);
      }
      /* 添加多图布局样式 */
      .results-container {
        margin-top: 30px;
        border-top: 1px solid #eee;
        padding-top: 20px;
      }

      .result-item {
        margin-bottom: 30px;
        padding: 15px;
        background-color: #f9f9f9;
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      }

      .result-header {
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .images-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
      }

      .image-card {
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease;
      }

      .image-card:hover {
        transform: translateY(-5px);
      }

      .generated-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        cursor: pointer;
      }

      .image-info {
        padding: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background-color: #f5f5f5;
      }

      .download-btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      .download-btn:hover {
        background-color: #45a049;
      }
    </style>
  </head>
  <body>
    <div id="app">
      <div class="container">
        <header>
          <div class="logo">
            <i class="fas fa-robot"></i>
            <h1>AI图像生成</h1>
            <span
              class="status-indicator"
              :class="isProcessing ? 'status-processing' : 'status-idle'"
            ></span>
          </div>
          <div class="preset-selector">
            <div class="preset-label">预设:</div>
            <button
              class="preset-btn"
              v-for="(preset, name) in presets"
              :key="name"
              @click="loadPreset(name)"
            >
              <i class="fas fa-cog"></i> {{ name }}
            </button>
          </div>
        </header>

        <div class="main-content">
          <!-- 参数配置面板 -->
          <div class="params-panel">
            <div class="panel-title">
              <i class="fas fa-sliders-h"></i>
              <span>参数配置</span>
            </div>

            <!-- 错误提示 -->
            <div class="error-message" v-if="errorMessage">
              <i class="fas fa-exclamation-circle"></i>
              {{ errorMessage }}
            </div>

            <!-- 基础参数 -->
            <div class="param-section">
              <div class="section-title">
                <i class="fas fa-cog"></i>
                <span>基础参数</span>
              </div>

              <div class="form-group">
                <label for="modelType">模型类型</label>
                <select id="modelType" v-model="params.modelType">
                  <optgroup label="文生图">
                    <option value="fluxschnell">fluxschnell</option>
                    <option value="wanx">通义万相</option>
                    <option value="openai">OpenAI</option>
                    <option value="civitai">Civitai</option>
                    <option value="qianwen">阿里云</option>
                    <option value="volc">字节跳动</option>
                  </optgroup>
                  <optgroup label="图生图">
                    <option value="volc_2">字节跳动</option>
                    <option value="qianwen_2">阿里云</option>
                  </optgroup>
                  <optgroup label="所有模型">
                    <option value="all">所有模型</option>
                  </optgroup>
                </select>
              </div>

              <div class="form-group">
                <label for="prompt"
                  >提示词 <span class="required">*</span></label
                >
                <textarea
                  id="prompt"
                  v-model="params.prompt"
                  placeholder="描述您希望生成的图像内容..."
                ></textarea>
              </div>

              <div class="form-group">
                <label for="negativePrompt">负面提示词</label>
                <textarea
                  id="negativePrompt"
                  v-model="params.negativePrompt"
                  placeholder="描述您不希望出现在图像中的内容..."
                ></textarea>
              </div>

              <div class="form-group" v-if="params.modelType === 'volc_2'">
                <label for="n">生成数量 <span class="required"></span></label>
                <input
                  type="number"
                  id="n"
                  v-model.number="params.n"
                  min="1"
                  max="15"
                  placeholder="输入1-15之间的数字"
                  @input="validateN"
                />
                <!-- <div v-if="nError" class="error">{{ nError }}</div> -->
              </div>

              <div class="form-group" v-if="!isImgToImgModel">
                <label for="modelUrn"
                  >模型URN (仅Civitai生效) <span class="required"></span
                ></label>
                <input
                  type="text"
                  id="modelUrn"
                  v-model="params.modelUrn"
                  placeholder="例如: urn:air:sd1:checkpoint:civitai:4384@128713"
                />
                <div class="hint">
                  格式示例: urn:air:sd1:checkpoint:civitai:4384@128713
                </div>
              </div>
            </div>

            <!-- 图生图参数 -->
            <div class="param-section" v-if="isImgToImgModel">
              <div class="section-title">
                <i class="fas fa-exchange-alt"></i>
                <span>图生图模式 <span class="required"> * </span></span>
                <!-- 必填标识 -->
              </div>
              <div class="form-group">
                <div
                  class="upload-area"
                  @click="triggerFileUpload"
                  @dragover.prevent
                  @drop="handleDrop"
                >
                  <i class="fas fa-cloud-upload-alt"></i>
                  <p>点击或拖放图片到此处上传</p>
                  <p class="hint">支持JPG/PNG格式，最大5MB</p>
                  <input
                    type="file"
                    id="fileInput"
                    ref="fileInput"
                    @change="handleImageUpload"
                    accept="image/jpeg,image/png"
                    style="display: none"
                  />
                  <img
                    :src="params.imageBase64"
                    class="image-preview"
                    v-if="params.imageBase64"
                  />
                </div>
              </div>
            </div>
            <!-- 图像参数 -->
            <div
              class="param-section"
              v-if="!isImgToImgModel || params.modelType==='volc_2'"
            >
              <div class="section-title" v-if="!isImgToImgModel">
                <i class="fas fa-image"></i>
                <span>图像参数</span>
              </div>

              <div class="form-group" v-if="!isImgToImgModel">
                <label for="width">宽度 (仅Civitai生效)</label>
                <input
                  type="number"
                  id="width"
                  v-model="params.width"
                  min="256"
                  max="2048"
                />
              </div>

              <div class="form-group" v-if="!isImgToImgModel">
                <label for="height">高度 (仅Civitai生效)</label>
                <input
                  type="number"
                  id="height"
                  v-model="params.height"
                  min="256"
                  max="2048"
                />
              </div>

              <div class="form-group">
                <label for="size">尺寸</label>
                <select id="size" v-model="params.size">
                  <!-- 根据模型类型动态显示尺寸选项 -->
                  <template v-if="params.modelType === 'openai'">
                    <optgroup label="OpenAI">
                      <option value="1024x1024">1024x1024</option>
                      <option value="1024x1792">1024x1792</option>
                      <option value="1792x1024">1792x1024</option>
                    </optgroup>
                  </template>
                  <template v-else-if="params.modelType === 'qianwen'">
                    <optgroup label="阿里云">
                      <option value="1664*928">1664 * 928</option>
                      <option value="1472*1140">1472 * 1140</option>
                      <option value="1328*1328">1328 * 1328</option>
                      <option value="1140*1472">1140 * 1472</option>
                      <option value="928*1664">928 * 1664</option>
                    </optgroup>
                  </template>
                  <template
                    v-else-if="params.modelType === 'volc'|| params.modelType ==='volc_2'"
                  >
                    <optgroup label="字节跳动">
                      <option value="2048x2048">2048x2048</option>
                      <option value="2304x1728">2304x1728</option>
                      <option value="1728x2304">1728x2304</option>
                      <option value="2560x1440">2560x1440</option>
                      <option value="1440x2560">1440x2560</option>
                      <option value="2496x1664">2496x1664</option>
                      <option value="1664x2496">1664x2496</option>
                      <option value="3024x1296">3024x1296</option>
                      <option value="4K">4K</option>
                      <option value="2K">2K</option>
                      <option value="1K">1K</option>
                    </optgroup>
                  </template>
                  <template v-else-if="params.modelType === 'wanx'">
                    <optgroup label="通义万相">
                      <option value="768*768">768 * 768</option>
                      <option value="576*1024">576 * 1024</option>
                      <option value="1024*576">1024 * 576</option>
                      <option value="1024*1024">1024 * 1024</option>
                      <option value="720*1280">720 * 1280</option>
                      <option value="1280*720">1280 * 720</option>
                      <option value="864*1152">864 * 1152</option>
                      <option value="1152*864">1152 * 864</option>
                    </optgroup>
                  </template>
                  <template v-else>
                    <option value="">无可用尺寸选项</option>
                  </template>
                </select>
              </div>
            </div>

            <!-- 高级参数 -->
            <div class="param-section" v-if="!isImgToImgModel">
              <div class="section-title">
                <i class="fas fa-tools"></i>
                <span>高级参数</span>
              </div>

              <div class="form-group">
                <label for="scheduler">调度器 (仅Civitai生效)</label>
                <select id="scheduler" v-model="params.scheduler">
                  <optgroup label="Euler家族">
                    <option value="EulerA">EulerA</option>
                    <option value="Euler">Euler</option>
                  </optgroup>
                  <optgroup label="DPM家族">
                    <option value="DPM2">DPM2</option>
                    <option value="DPM2A">DPM2A</option>
                    <option value="DPM2SA">DPM2SA</option>
                    <option value="DPM2M">DPM2M</option>
                  </optgroup>
                  <optgroup label="Karras家族">
                    <option value="LMSKarras">LMSKarras</option>
                    <option value="DPM2Karras">DPM2Karras</option>
                  </optgroup>
                  <optgroup label="其他">
                    <option value="DDIM">DDIM</option>
                    <option value="PLMS">PLMS</option>
                    <option value="LCM">LCM</option>
                  </optgroup>
                </select>
              </div>

              <div class="form-group">
                <label for="steps">迭代步数 (1-100)</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="steps"
                    v-model="params.steps"
                    min="1"
                    max="100"
                  />
                  <div class="slider-value">{{ params.steps }}</div>
                </div>
              </div>

              <div class="form-group">
                <label for="cfgScale">CFG尺度 (0-20)</label>
                <div class="slider-container">
                  <input
                    type="range"
                    id="cfgScale"
                    v-model="params.cfgScale"
                    min="0"
                    max="20"
                    step="0.1"
                  />
                  <div class="slider-value">{{ params.cfgScale }}</div>
                </div>
              </div>

              <div class="form-group">
                <label for="seed">随机种子</label>
                <input type="number" id="seed" v-model="params.seed" min="0" />
              </div>

              <div class="form-group">
                <label for="clipSkip">CLIP跳过层数 (1-12)</label>
                <input
                  type="number"
                  id="clipSkip"
                  v-model="params.clipSkip"
                  min="1"
                  max="12"
                />
              </div>
            </div>

            <div class="btn-group">
              <button
                class="btn btn-secondary"
                @click="savePreset"
                :disabled="isProcessing"
              >
                <i class="fas fa-save"></i> 保存预设
              </button>
              <button
                class="btn btn-primary"
                @click="submitTask"
                :disabled="isProcessing"
              >
                <i class="fas fa-magic"></i> {{ isProcessing ? '生成中...' :
                '生成图像' }}
              </button>
            </div>
          </div>

          <!-- 结果展示面板 -->
          <div class="results-panel">
            <div class="panel-title">
              <i class="fas fa-images"></i>
              <span>生成结果</span>
            </div>

            <!-- 进度条 -->
            <div class="progress-container" v-if="isProcessing">
              <div class="progress-text">处理中: {{ progressMessage }}</div>
              <div class="progress-bar">
                <div
                  class="progress-fill"
                  :style="{width: progress + '%'}"
                ></div>
              </div>
              <div class="progress-text">{{ progress }}%</div>
            </div>

            <!-- 结果展示部分 -->
            <div class="results-container" v-if="results.length > 0">
              <!-- 多模型结果展示（模型类型为'all'） -->
              <template v-if="params.modelType === 'all'">
                <div
                  class="result-item"
                  v-for="(result, resultIndex) in results"
                  :key="resultIndex"
                >
                  <!-- 多图展示 -->
                  <div
                    v-if="result.images && result.images.length > 1"
                    class="multi-image-container"
                  >
                    <div class="images-grid">
                      <div
                        v-for="(image, imageIndex) in result.images"
                        :key="imageIndex"
                        class="image-card"
                      >
                        <img
                          :src="image.url"
                          class="result-image"
                          @click="showImageDetail({...result, ...image})"
                        />
                        <div class="image-info">
                          <span class="image-index"
                            >图片 {{ image.index }}/{{ image.total }}</span
                          >
                          <a
                            href="#"
                            class="action-btn download-btn"
                            @click="handleDownload($event, image.url, result.model, imageIndex)"
                          >
                            <i class="fas fa-download"></i>
                          </a>
                        </div>
                      </div>
                    </div>

                    <div class="result-info">
                      <div class="result-model">{{ result.model }}</div>
                      <div class="result-prompt">{{ result.prompt }}</div>
                      <div class="action-buttons">
                        <a
                          href="#"
                          class="action-btn view-btn"
                          @click.prevent="showImageDetail({...result, ...result.images[0]})"
                        >
                          <i class="fas fa-search-plus"></i> 查看详情
                        </a>
                      </div>
                    </div>
                  </div>

                  <!-- 单图展示 -->
                  <div v-else>
                    <div v-if="result.images && result.images.length > 0">
                      <img
                        :src="result.images[0].url"
                        class="result-image"
                        @click="showImageDetail({...result, ...result.images[0]})"
                      />
                      <div class="result-info">
                        <div class="result-model">{{ result.model }}</div>
                        <div class="result-prompt">{{ result.prompt }}</div>
                        <div class="action-buttons">
                          <a
                            href="#"
                            class="action-btn view-btn"
                            @click.prevent="showImageDetail({...result, ...result.images[0]})"
                          >
                            <i class="fas fa-search-plus"></i> 查看详情
                          </a>
                          <a
                            href="#"
                            class="action-btn download-btn"
                            @click="handleDownload($event, result.images[0].url, result.model, resultIndex)"
                          >
                            <i class="fas fa-download"></i> 下载
                          </a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </template>

              <!-- 单模型结果展示 -->
              <div class="single-result" v-else>
                <!-- 多图展示 -->
                <div
                  v-if="results[0].images && results[0].images.length > 1"
                  class="multi-image-container"
                >
                  <div class="images-grid">
                    <div
                      v-for="(image, imageIndex) in results[0].images"
                      :key="imageIndex"
                      class="image-card"
                    >
                      <img
                        :src="image.url"
                        class="result-image"
                        @click="showImageDetail({...results[0], ...image})"
                      />
                      <div class="image-info">
                        <span class="image-index"
                          >图片 {{ image.index }}/{{ image.total }}</span
                        >
                        <a
                          href="#"
                          class="action-btn download-btn"
                          @click="handleDownload($event, image.url, results[0].model, imageIndex)"
                        >
                          <i class="fas fa-download"></i>
                        </a>
                      </div>
                    </div>
                  </div>
                  <div class="result-details">
                    <div class="detail-row">
                      <div class="detail-label">模型:</div>
                      <div class="detail-value">{{ results[0].model }}</div>
                    </div>
                    <div class="detail-row" v-if="results[0].width">
                      <div class="detail-label">尺寸:</div>
                      <div class="detail-value">
                        {{ results[0].width }}×{{ results[0].height }}
                      </div>
                    </div>
                    <div class="action-buttons">
                      <a
                        href="#"
                        class="action-btn view-btn"
                        @click.prevent="showImageDetail({...results[0], ...results[0].images[0]})"
                      >
                        <i class="fas fa-search-plus"></i> 查看详情
                      </a>
                    </div>
                  </div>
                </div>

                <!-- 单图展示 -->
                <div v-else>
                  <div v-if="results[0].images && results[0].images.length > 0">
                    <img
                      :src="results[0].images[0].url"
                      class="single-image"
                      @click="showImageDetail({...results[0], ...results[0].images[0]})"
                    />
                    <div class="result-details">
                      <div class="detail-row">
                        <div class="detail-label">模型:</div>
                        <div class="detail-value">{{ results[0].model }}</div>
                      </div>
                      <div class="detail-row" v-if="results[0].width">
                        <div class="detail-label">尺寸:</div>
                        <div class="detail-value">
                          {{ results[0].width }}×{{ results[0].height }}
                        </div>
                      </div>
                      <div class="action-buttons">
                        <a
                          href="#"
                          class="action-btn view-btn"
                          @click.prevent="showImageDetail({...results[0], ...results[0].images[0]})"
                        >
                          <i class="fas fa-search-plus"></i> 查看详情
                        </a>
                        <a
                          href="#"
                          class="action-btn download-btn"
                          @click="handleDownload($event, results[0].images[0].url, results[0].model, 0)"
                        >
                          <i class="fas fa-download"></i> 下载
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- 在模板中添加图片详情模态框 -->
            <!-- 图片详情模态框 -->
            <div v-if="selectedImage" class="image-detail-modal">
              <div class="modal-content">
                <button class="close-btn" @click="closeImageDetail">
                  <i class="fas fa-times"></i>
                </button>
                <div class="image-header">
                  <h3>{{ selectedImage.model }}</h3>
                  <div v-if="selectedImage.total > 1" class="image-counter">
                    图片 {{ selectedImage.index }} / {{ selectedImage.total }}
                  </div>
                </div>
                <img :src="selectedImage.url" class="detail-image" />
              </div>
            </div>

            <!-- 无结果状态 -->
            <div class="no-results" v-else-if="!results">
              <i class="fas fa-image"></i>
              <h3>尚未生成图像</h3>
              <p>配置参数并点击"生成图像"按钮开始</p>
            </div>

            <!-- 历史记录 -->
            <div class="history-panel" v-if="history.length > 0">
              <div class="history-header">
                <div class="panel-title">
                  <i class="fas fa-history"></i>
                  <span>历史记录</span>
                </div>
                <button class="clear-history-btn" @click="clearHistory">
                  <i class="fas fa-trash-alt"></i> 清空
                </button>
              </div>
              <div
                class="history-item"
                v-for="(item, index) in history"
                :key="index"
                @click="loadHistory(item)"
              >
                <div class="history-title">
                  <span>任务 #{{ index + 1 }}</span>
                  <span class="history-date"
                    >{{ formatDate(item.timestamp) }}</span
                  >
                </div>
                <div class="history-prompt">{{ item.params.prompt }}</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const { createApp, ref, reactive, onMounted, watch, computed } = Vue;
      // 图生图模型
      const IMG_TO_IMG_MODELS = ["volc_2", "qianwen_2"];
      const fileInput = ref(null);

      createApp({
        setup() {
          // 参数配置
          const params = reactive({
            modelUrn: "",
            prompt: "",
            negativePrompt: "",
            modelType: "",
            width: 1024,
            height: 768,
            size: "",
            scheduler: "EulerA",
            steps: 20,
            cfgScale: 7,
            seed: Math.floor(Math.random() * 1000000),
            clipSkip: 1,
            imageBase64: null,
            n: "",
          });
          const selectedImage = ref(null); // 存储选中的图片详情
          // 显示图片详情的方法
          const showImageDetail = (imageData) => {
            selectedImage.value = {
              url: imageData.url,
              model: imageData.model,
              width: imageData.width,
              height: imageData.height,
              prompt: imageData.prompt,
              index: imageData.index || 1, // 默认为1
              total: imageData.total || 1, // 默认为1
            };
          };
          // 关闭图片详情的方法
          const closeImageDetail = () => {
            selectedImage.value = null;
          };
          const modelDefaultSizes = {
            openai: "",
            qianwen: "",
            volc: "",
            wanx: "",
            civitai: "",
            fluxschnell: "",
            all: "",
          };
          // 判断当前是否为图生图模型
          const isImgToImgModel = computed(() => {
            const imgToImgModels = ["volc_2", "qianwen_2"];
            return imgToImgModels.includes(params.modelType);
          });
          // 验证n值是否在有效范围内
          const validateN = () => {
            if (params.modelType !== "volc_2") return;
            const nValue = params.n;
            if (nValue === null || nValue === "") {
              this.nError = "";
              return;
            }
            // 转换为数字
            const num = Number(nValue);
            if (isNaN(num)) {
              alert("请输入有效的数字");
              return;
            } else if (num < 1 || num > 15) {
              alert("生成数量必须在1-15之间");
              return;
            }
          };
          // 监听模型类型变化
          watch(
            () => params.modelType,
            (newModelType, oldModelType) => {
              // 重置尺寸参数
              params.size = null;
              params.n = null;
              // 处理图生图模型切换
              const wasImgToImg = IMG_TO_IMG_MODELS.includes(oldModelType);
              const isNowImgToImg = IMG_TO_IMG_MODELS.includes(newModelType);
              if (wasImgToImg && !isNowImgToImg) {
                // 从图生图切换到文生图：清空图片数据
                params.imageBase64 = null;
                // 重置文件输入框
                if (fileInput.value) {
                  fileInput.value.value = "";
                }
                console.log(`已从图生图模型切换到文生图模型，已清空图片数据`);
              }
            },
            { immediate: true } // 组件挂载时立即执行一次
          );
          // 状态变量
          const isProcessing = ref(false);
          const progress = ref(0);
          const progressMessage = ref("任务初始化");
          const results = ref([]);
          const history = ref([]);
          const selectedPreset = ref("");
          const fileInput = ref(null);
          const errorMessage = ref("");
          const presets = ref({});
          const handleDownload = async (event, imageUrl, modelName, index) => {
            event.preventDefault();
            if (!imageUrl) return;
            // 保存原始按钮状态
            const originalText = event.target.innerHTML;
            event.target.innerHTML =
              '<i class="fas fa-spinner fa-spin"></i> 下载中...';
            event.target.disabled = true;
            let link = null;
            let url = null;
            try {
              // 获取图片数据
              const response = await fetch(imageUrl);
              if (!response.ok) {
                throw new Error(
                  `下载失败: ${response.status} ${response.statusText}`
                );
              }
              // 转换为 Blob
              const blob = await response.blob();
              // 创建下载链接
              url = URL.createObjectURL(blob);
              link = document.createElement("a");
              link.href = url;
              // 设置下载文件名
              const fileName = getDownloadFileName(imageUrl, modelName, index);
              link.download = fileName.replace(/[^a-zA-Z0-9._-]/g, "_");
              // 触发下载
              document.body.appendChild(link);
              link.click();
              // 添加延迟确保下载开始
              await new Promise((resolve) => setTimeout(resolve, 500));
            } catch (error) {
              console.error("下载失败:", error);
              // 直接在新窗口中打开图片
              window.open(imageUrl, "_blank");
            } finally {
              // 清理资源
              if (link && document.body.contains(link)) {
                document.body.removeChild(link);
              }
              if (url) {
                URL.revokeObjectURL(url);
              }
              event.target.innerHTML = originalText;
              event.target.disabled = false;
            }
          };

          // 生成下载文件名的方法
          const getDownloadFileName = (imageUrl, modelName, index) => {
            // 生成随机唯一标识
            const timestamp = Date.now(); // 当前时间戳
            const randomNum = Math.floor(Math.random() * 10000); // 4位随机数
            const cleanModelName = (modelName || "image").replace(
              /[^a-zA-Z0-9]/g,
              "_"
            );
            // 尝试从URL中提取文件扩展名
            let extension = ".png"; // 默认扩展名
            if (typeof imageUrl === "string") {
              // 尝试从URL中提取文件名部分
              const urlParts = imageUrl.split("/");
              const lastPart = urlParts[urlParts.length - 1];
              // 检查是否有查询参数
              const filePart = lastPart.split("?")[0];
              // 检查是否有扩展名
              const dotIndex = filePart.lastIndexOf(".");
              if (dotIndex > -1) {
                const possibleExt = filePart
                  .substring(dotIndex + 1)
                  .toLowerCase();
                // 只保留常见的图片扩展名
                if (
                  ["png", "jpg", "jpeg", "webp", "gif"].includes(possibleExt)
                ) {
                  extension = `.${possibleExt}`;
                }
              }
            }
            // 使用模型名、时间戳、随机数和索引创建唯一文件名
            return `${cleanModelName}_${timestamp}_${randomNum}_${index}${extension}`;
          };
          // API基础URL
          const API_BASE_URL =
            "https://ztdvknsvl6.execute-api.us-west-1.amazonaws.com/ai/image";

          // 从localStorage加载预设和历史记录
          const loadFromStorage = () => {
            // 加载预设
            const savedPresets = localStorage.getItem("aiImagePresets");
            if (savedPresets) {
              try {
                presets.value = JSON.parse(savedPresets);
              } catch (e) {
                console.error("加载预设失败:", e);
              }
            }

            // 加载历史记录
            const savedHistory = localStorage.getItem("aiImageHistory");
            if (savedHistory) {
              try {
                history.value = JSON.parse(savedHistory);
              } catch (e) {
                console.error("加载历史记录失败:", e);
              }
            }
          };

          // 保存预设到localStorage
          const savePresetsToStorage = () => {
            localStorage.setItem(
              "aiImagePresets",
              JSON.stringify(presets.value)
            );
          };

          // 保存历史记录到localStorage
          const saveHistoryToStorage = () => {
            try {
              localStorage.setItem(
                "aiImageHistory",
                JSON.stringify(history.value)
              );
            } catch (error) {
              if (error.name === "QuotaExceededError") {
                console.warn("存储空间不足，自动清理旧记录");
                // 清理一半旧记录
                const halfIndex = Math.ceil(history.value.length / 2);
                history.value = history.value.slice(0, halfIndex);
                // 再次尝试保存
                localStorage.setItem(
                  "aiImageHistory",
                  JSON.stringify(history.value)
                );
              } else {
                console.error("保存历史记录失败:", error);
              }
            }
          };
          // 加载预设
          const loadPreset = (presetName) => {
            if (!presetName || isProcessing.value) return;

            const preset = presets.value[presetName];
            if (preset) {
              // 复制预设值到params，排除imageBase64
              Object.keys(preset).forEach((key) => {
                if (key !== "imageBase64") {
                  params[key] = preset[key];
                }
              });
              alert(`预设 "${presetName}" 已加载`);
            } else {
              alert(`预设 "${presetName}" 不存在`);
            }
          };

          // 保存预设
          const savePreset = () => {
            if (isProcessing.value) return;

            const presetName = prompt("请输入预设名称:");
            if (presetName) {
              // 创建预设副本，排除imageBase64
              const presetToSave = { ...params };
              delete presetToSave.imageBase64;

              presets.value[presetName] = presetToSave;
              savePresetsToStorage();
              alert(`预设 "${presetName}" 已保存`);
            }
          };

          // 清空历史记录
          const clearHistory = () => {
            if (confirm("确定要清空所有历史记录吗？")) {
              history.value = [];
              localStorage.removeItem("aiImageHistory");
            }
          };

          // 触发文件上传
          const triggerFileUpload = () => {
            if (isProcessing.value) return;
            fileInput.value.click();
          };

          // 处理拖放
          const handleDrop = (e) => {
            if (isProcessing.value) return;

            e.preventDefault();
            const file = e.dataTransfer.files[0];
            if (file) {
              processImage(file);
            }
          };
          // 处理图片上传
          const handleImageUpload = (e) => {
            if (isProcessing.value) return;

            const file = e.target.files[0];
            if (file) {
              processImage(file);
            }
          };
          // 处理图片并转换为Base64
          const processImage = (file) => {
            if (
              !file.type.match("image/jpeg") &&
              !file.type.match("image/png")
            ) {
              alert("只支持JPG和PNG格式的图片");
              return;
            }
            if (file.size > 5 * 1024 * 1024) {
              alert("图片大小不能超过5MB");
              return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
              params.imageBase64 = e.target.result;
            };
            reader.readAsDataURL(file);
          };

          const submitTask = async () => {
            if (isProcessing.value) return;
            if (isImgToImgModel.value) {
              if (!params.imageBase64) {
                alert("请上传图片");
                console.log(`${params.imageBase64 ? "" : "请上传图片"}`);
                return;
              }
              console.log(`${params.imageBase64 ? "" : "请上传图片"}`);
              console.log(`modelType: ${params.modelType}`);
            }
            if (!params.prompt) {
              alert("提示词是必填项");
              return;
            }

            errorMessage.value = "";
            isProcessing.value = true;
            progressMessage.value = "提交任务中...";
            progress.value = 0;

            try {
              // 提交任务到服务器
              progressMessage.value = "正在连接服务器...";
              console.log("params", params);
              const taskId = await submitTaskToServer(params);
              // 确认任务已接收后再更新进度
              progress.value = 10;
              progressMessage.value = "任务已提交，等待处理...";
              // 开始轮询
              await pollTaskStatus(taskId);
              // 成功后添加到历史记录
              console.log("addHis", params, results.value);
              addToHistory(params, results.value);
            } catch (error) {
              console.error("任务失败:", error);
              errorMessage.value = "任务失败: " + error.message;
              progressMessage.value = "任务失败: " + error.message;
              progress.value = 0;
            } finally {
              isProcessing.value = false;
            }
          };
          // 提交任务到服务器
          const submitTaskToServer = async (data) => {
            console.log("data sub", data);
            try {
              const payload = { ...data };
              if (payload.modelType && payload.imageBase64) {
                payload.modelType = payload.modelType.split("_2")[0];
              }
              if (payload.modelType === "volc" && payload.n !== undefined) {
                const generateCount = Math.min(
                  15,
                  Math.max(1, parseInt(payload.n, 10) || 1)
                );
                const imageNoun = generateCount === 1 ? "image" : "images";
                const countPrompt = `Please generate ${generateCount} high-quality natural ${imageNoun} `;
                payload.prompt = payload.prompt
                  ? `${payload.prompt.trim()}, ${countPrompt.trim()}`
                  : countPrompt.trim();
              }
              payload.prompt += `Please generate ${payload.n} sheets `;
              console.log("payload", payload);
              const response = await fetch(`${API_BASE_URL}`, {
                method: "POST",
                headers: {
                  "Content-Type": "application/json",
                  "x-api-key": "1121231d2-30d2-4bd6-a7d9-1a84df4ae2ds1b6",
                },
                body: JSON.stringify(payload),
              });
              console.log("response", response);
              if (!response.ok) {
                throw new Error(`服务器错误: ${response.status}`);
              }
              const result = await response.json();
              console.log("result", result);
              return result.taskId;
            } catch (error) {
              throw new Error(`提交任务失败: ${error.message}`);
            }
          };

          // 轮询任务状态
          const pollTaskStatus = async (taskId) => {
            const POLL_INTERVAL = 4000; // 轮询间隔（保持4秒/次，兼顾性能与实时性）
            const TOTAL_TIMEOUT = 7 * 60 * 1000; // 总超时时间：7分钟（毫秒）
            const maxAttempts = Math.ceil(TOTAL_TIMEOUT / POLL_INTERVAL); // 计算最大轮询次数：7*60*1000/4000=105次
            let attempts = 0;

            // 初始化显示
            progressMessage.value = "任务启动中...";
            progress.value = 0;

            return new Promise((resolve, reject) => {
              const interval = setInterval(async () => {
                try {
                  // 超过最大轮询次数 → 超时终止
                  if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    const timeoutMsg = "任务超时";
                    reject(new Error(timeoutMsg));
                    return;
                  }
                  attempts++;

                  const res = await getTaskStatus(taskId);
                  console.log("轮询结果:", res);
                  const progressValue =
                    res.progress !== undefined ? res.progress : progress.value;
                  // 更新进度显示
                  progress.value = progressValue;

                  switch (res.status) {
                    case "pending":
                      progressMessage.value = "准备生成";
                      break;
                    case "running":
                      progressMessage.value = `生成中 (${progressValue}%)`;
                      break;
                    case "completed":
                      clearInterval(interval);
                      progressMessage.value = "生成完成";
                      // 确保结果格式正确
                      results.value = Array.isArray(res.result)
                        ? res.result
                        : [res.result];
                      resolve(res.result);
                      break;
                    case "failed":
                      clearInterval(interval);
                      reject(new Error(res.error || "任务执行失败"));
                      break;
                    default:
                      progressMessage.value = `等待中（${Math.ceil(
                        (TOTAL_TIMEOUT - attempts * POLL_INTERVAL) / 1000
                      )}秒后超时）`;
                  }
                } catch (error) {
                  clearInterval(interval);
                  reject(new Error(`轮询失败：${error.message}`));
                }
              }, POLL_INTERVAL);
            });
          };
          // 获取任务状态
          const getTaskStatus = async (taskId) => {
            try {
              const response = await fetch(`${API_BASE_URL}?taskId=${taskId}`, {
                headers: {
                  "x-api-key": "1121231d2-30d2-4bd6-a7d9-1a84df4ae2ds1b6",
                },
              });
              if (!response.ok) {
                throw new Error(`服务器错误: ${response.status}`);
              }
              return await response.json();
            } catch (error) {
              throw new Error(`获取任务状态失败: ${error.message}`);
            }
          };
          // 添加到历史记录（优化存储）
          const addToHistory = (params, result) => {
            // 创建精简版历史项
            const historyItem = {
              timestamp: new Date(),
              params: {
                modelType: params.modelType,
                prompt: params.prompt,
                negativePrompt: params.negativePrompt,
                width: params.width,
                height: params.height,
                steps: params.steps,
                cfgScale: params.cfgScale,
                seed: params.seed,
              },
              result: result.map((res) => {
                // 处理多图情况
                if (res.images && Array.isArray(res.images)) {
                  return {
                    images: res.images.map((img) => ({
                      url: img.url,
                      index: img.index,
                      total: img.total,
                    })),
                    model: res.model,
                    width: res.width,
                    height: res.height,
                    prompt: res.prompt,
                  };
                }
                // 兼容旧格式
                return {
                  imageUrl: res.imageUrl || (res.images && res.images[0]?.url),
                  model: res.model,
                  width: res.width,
                  height: res.height,
                  prompt: res.prompt,
                };
              }),
            };
            // 添加到历史记录数组开头
            history.value.unshift(historyItem);
            // 限制历史记录数量（最多10条）
            const MAX_HISTORY_ITEMS = 10;
            if (history.value.length > MAX_HISTORY_ITEMS) {
              history.value = history.value.slice(0, MAX_HISTORY_ITEMS);
            }
            // 保存到localStorage
            saveHistoryToStorage();
          };
          // 加载历史记录
          const loadHistory = (item) => {
            if (isProcessing.value) return;

            // 复制历史记录参数到当前表单
            Object.assign(params, {
              modelType: item.params.modelType,
              prompt: item.params.prompt,
              negativePrompt: item.params.negativePrompt,
              width: item.params.width,
              height: item.params.height,
              steps: item.params.steps,
              cfgScale: item.params.cfgScale,
              seed: item.params.seed,
              imageBase64: null,
            });

            // 显示历史记录结果
            results.value = item.result.map((res) => {
              // 处理多图历史记录
              if (res.images && Array.isArray(res.images)) {
                return {
                  success: true,
                  images: res.images,
                  model: res.model,
                  width: res.width,
                  height: res.height,
                  prompt: res.prompt,
                };
              }
              // 兼容旧格式
              return {
                success: true,
                imageUrl: res.imageUrl,
                model: res.model,
                width: res.width,
                height: res.height,
                prompt: res.prompt,
              };
            });
          };
          // 格式化日期
          const formatDate = (date) => {
            const d = new Date(date);
            return `${d.getFullYear()}-${(d.getMonth() + 1)
              .toString()
              .padStart(2, "0")}-${d.getDate().toString().padStart(2, "0")} ${d
              .getHours()
              .toString()
              .padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`;
          };

          // 初始化
          onMounted(() => {
            loadFromStorage();
          });

          return {
            params,
            isProcessing,
            progress,
            progressMessage,
            results,
            history,
            selectedPreset,
            fileInput,
            errorMessage,
            presets,
            loadPreset,
            savePreset,
            clearHistory,
            triggerFileUpload,
            handleDrop,
            handleImageUpload,
            submitTask,
            loadHistory,
            formatDate,
            getDownloadFileName,
            handleDownload,
            isImgToImgModel,
            selectedImage,
            showImageDetail,
            closeImageDetail,
            validateN,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
